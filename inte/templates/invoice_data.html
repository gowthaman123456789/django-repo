<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invoice Data</title>
    <link rel="stylesheet" href="static/invoice_data.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Extracted Invoice Data</h1>
        {% for item in extracted_data %}
            {% for key, value in item.items %}
                {% if key != 'Items' %}
                    <p>{{ key }}: <span id="{{ key }}">{{ value }}</span> <input type="text" id="edit_{{ key }}" value="{{ value }}" style="display: none;"></p>
                {% endif %}
            {% endfor %}
            {% if item.Items %}
                <table id="editableTable">
                    <thead>
                        <tr>
                            <th>ProductCode</th>
                            <th>Barcode</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>UnitPrice</th>
                            <th>Unit</th>
                            <th>Tax</th>
                            <th>TaxRate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item_data in item.Items %}
                            <tr>
                                <td>{{ item_data.ProductCode }}</td>
                                <td>{{ item_data.Barcode }}</td>
                                <td>{{ item_data.Description }}</td>
                                <td>{{ item_data.Quantity }}</td>
                                <td>{{ item_data.UnitPrice }}</td>
                                <td>{{ item_data.Unit }}</td>
                                <td>{{ item_data.Tax }}</td>
                                <td>{{ item_data.TaxRate }}</td>
                                <td>{{ item_data.Amount }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endfor %}
    </div>
    <div class="button-container" style="text-align: center;">
        <button class="edit-button" onclick="toggleEdit()">Edit Data</button>
        <button class="save-button" onclick="saveData()" style="display: none;">Save</button>
        <button class="print-button" onclick="printInvoice()">Print Invoice</button>
        <button class="sap-button" onclick="pushToSAP()">Push JSON to SAP</button>
    </div>
    <script>
        function printInvoice() {
            window.print();
        }

        function toggleEdit() {
            var inputs = document.querySelectorAll('input[type="text"]');
            var spans = document.querySelectorAll('span');
            var cells = document.querySelectorAll('#editableTable td');
            inputs.forEach((input, index) => {
                input.style.display = 'inline';
                input.value = spans[index].innerText;
            });
            spans.forEach(span => span.style.display = 'none');
            cells.forEach(cell => cell.setAttribute('contenteditable', true));
            document.querySelector('.save-button').style.display = 'block';
        }

        function saveData() {
            var inputs = document.querySelectorAll('input[type="text"]');
            var spans = document.querySelectorAll('span');
            var cells = document.querySelectorAll('#editableTable td');
            inputs.forEach((input, index) => {
                spans[index].innerText = input.value;
                input.style.display = 'none';
                spans[index].style.display = 'inline';
            });
            cells.forEach(cell => cell.setAttribute('contenteditable', false));
            document.querySelector('.save-button').style.display = 'none';

            // Send edited data to the server
            sendEditedData();
        }

        function sendEditedData() {
            var editedData = {};
            var inputs = document.querySelectorAll('#editableTable input[type="text"]');
            inputs.forEach(input => {
                var fieldName = input.id.substring(5); // Remove 'edit_' prefix
                editedData[fieldName] = input.value;
            });

            fetch('/update_data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(editedData)
            })
            .then(response => {
                if (response.ok) {
                    console.log("Edited data sent successfully!");
                } else {
                    console.error("Failed to send edited data:", response.status);
                }
            })
            .catch(error => {
                console.error("Error sending edited data:", error);
            });
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function pushToSAP() {
    var jsonData = [];
    var rows = document.querySelectorAll('#editableTable tbody tr');

    rows.forEach((row, index) => {
        var rowData = {};
        var cells = row.querySelectorAll('td');

        cells.forEach((cell, cellIndex) => {
            var columnHeaderElement = document.querySelector('#editableTable thead tr th:nth-child(' + (cellIndex + 1) + ')');
            var columnHeader = columnHeaderElement ? columnHeaderElement.innerText : '';
            rowData[columnHeader] = cell.innerText;
        });

        jsonData.push(rowData);
    });

    console.log("Pushing JSON data to SAP...");
    console.log("JSON Data:", jsonData);

    // Construct the URL with the JSON data
    var sap_url = "http://savic1909.savictech.com:8000/sap/bc/abap/zmigo_vk/rest/?sap-client=220&req=" + encodeURIComponent(JSON.stringify(jsonData));

    // Define your username and password
    var username = "SAIP";
    var password = "Praneeth@10";

    // Encode the credentials
    var credentials = btoa(username + ':' + password);

    // Make a GET request to push JSON data into SAP
    fetch(sap_url, {
        method: 'GET',
        headers: {
            'Authorization': 'Basic ' + credentials
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log("JSON data retrieved successfully from SAP portal!");
        console.log("Response:", data);
        alert("JSON data pushed to SAP successfully!");
    })
    .catch(error => {
        console.error("Failed to push JSON data to SAP portal:", error);
        alert("Failed to push JSON data to SAP. Please try again!");
    });
}

    </script>
</body>
</html>
